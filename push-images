#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

IMAGE_TAG=${IMAGE_TAG:-$(./tools/image-tag)}

usage() {
    echo "$0"
    exit 2
}

while [ $# -gt 0 ]; do
    case "$1" in
        *)
            usage
            exit 2
            ;;
    esac
done

push_image() {
    local image="$1"
    echo "Pushing ${image}:${IMAGE_TAG}"
    docker push "${image}:${IMAGE_TAG}"

    # TODO: Check if it is a tag `v[0-9].[0-9].[0-9]` and if it is the latest release push a latest tag
}

# Push images
for image in $(make images ); do
    image_name=$(basename "$image")
    case "$image_name" in
        mimir-build-image)
            # skip mimir-build-image
            continue
            ;;
        mimir|mimirtool)
            old_image="$image"
            image="docker.io/grafana/${image_name}"
            docker tag "${old_image}:${IMAGE_TAG}" "${image}:${IMAGE_TAG}"
            ;;
    esac
    push_image "${image}"
done
